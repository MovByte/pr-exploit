const express = require("express");
const path = require("path");
const fs = require("fs");
var url = require("url");

const app = express();

const staticDir = "public";

const allow = (req, res, next) => {
  res.status(200).links({
    "payment-method-manifest":
      "https://pr-exploit.glitch.me/pay/pr-manifest.json",
  });
  if (req.path.endsWith("pr-manifest.json"))
    res.set("Content-Type", "application/x-payment-manifest");
  res.set("Referrer-Policy", "unsafe-url");
  next();
};

app.use(allow);

app.get("/pay_*/", (_req, res) => {
  fs.readFile(
    path.join(__dirname, staticDir, `pay/index.html`),
    (err, data) => {
      if (err) res.sendStatus(404);
      else {
        res.set("Content-Type", "text/html");
        res.send(data);
      }
    }
  );
});

app.get("/pay/manifest.json", (req, res) => {
  // data: urls can be blocked in the policy, but not in extensions
  let iconURL =
    "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
  // This feature isn't complete
  try {
    const parsedReferrer = url.parse(req.headers["referrer"], true);

    if ("unblocked_image_url_for_manifest" in parsedReferrer)
      iconURL = parsedReferrer.query["unblocked_image_url_for_manifest"];
  } catch (e) {}
  res.set("Content-Type", "application/manifest+json");
  res.send(`{
    "name": "Unblock",
    "short_name": "Unblocker",
    "icons": [{
      "src": "${iconURL}",
      "sizes": "1x1",
      "type": "image/png"
    }],
    "serviceworker": {
      "src": "/pay/sw.js",
      "use_cache": false
    }
  }`);
});

// This tech will eventually land itself in Filter Lock
// For GUC
app.get("/index.xml", (_req, res) => {
  fs.readFile(path.join(__dirname, staticDir, "index.html"), (err, data) => {
    if (err) res.sendStatus(404);
    else {
      res.set("Content-Type", "application/xml");
      res.send(`<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="Exploit"/> 
	<Content type="html">
    <![CDATA[ 
      ${data}
    ]]> 
	</Content>
</Module>`);
    }
  });
});
// For JSDelivr
app.get("/index.svg", (_req, res) => {
  fs.readFile(path.join(__dirname, staticDir, `index.html`), (err, data) => {
    if (err) res.sendStatus(404);
    else {
      res.set("Content-Type", "image/svg+xml");
      res.send(`
<svg xmlns="http://www.w3.org/2000/svg">
  <foreignObject width="100%" height="100%">
    <meta name="robots" content="noindex, follow" />
    <body xmlns="http://www.w3.org/1999/xhtml">
      ${data}
    </body>
  </foreignObject>
</svg>`);
    }
  });
});
app.use(express.static(path.join(__dirname, staticDir)));

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log(`Server listening on port ${port}`);
});
