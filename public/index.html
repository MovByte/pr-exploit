<link
  href="https://fonts.googleapis.com/icon?family=Material+Icons"
  rel="stylesheet"
/>

<link
  type="text/css"
  rel="stylesheet"
  href="css/materialize.min.css"
  media="screen,projection"
/>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
  rel="stylesheet"
/>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  integrity="sha512-UJfAaOlIRtdR+0P6C3KUoTDAxVTuy3lnSXLyLKlHYJlcSU8Juge/mjeaxDNMlw9LgeIotgz5FP8eUQPhX1q10A=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>

<style>
  body {
    font-family: "IBM Plex Sans", sans-serif;
    font-weight: 500;
    font-style: normal;
  }
  details {
    list-style-position: outside;
    margin-left: 1em;
    padding: 1em;
  }
  summary {
    font-size: 1.3em;
  }
</style>

<script>
  let hashProvided = window.location.hash !== "";

  function errr(msg) {
    alert(`Error: ${msg}`);
  }

  const unblockedImageSelectionUI = {
    show: () =>
      (document.getElementById("requiresImageURL").style.display = "default"),
    hide: () =>
      (document.getElementById("requiresImageURL").style.display = "none"),
  };

  var requiresImageURLBool = !!localStorage.getItem("requiresImageURL");

  async function unblock(url = window.location.hash.substring(1)) {
    if (!("PaymentRequest" in window)) {
      errr(
        "the Payment Request API is not supported in your browser. See https://caniuse.com/payment-request."
      );
      return;
    }

    if (url === "") {
      errr("The URL provided is blank");
      return;
    } else
      try {
        const parsedURL = new URL(url);
        if (
          parsedURL.protocol === "http:" &&
          parsedURL.hostname !== "localhost"
        ) {
          err("the URL needs to be of a Secure Context. Try https instead.");
          return;
        }
      } catch (err) {
        errr("invalid URL provided");
        return;
      }

    const request = new PaymentRequest(
      [
        {
          supportedMethods: `https://pr-exploit.glitch.me/pay`,
        },
      ],
      {
        id: url,
        total: {
          label: "total",
          amount: { value: "1", currency: "USD" },
        },
      }
    );
    try {
      const paymentResponse = await request.show();
    } catch (err) {
      if (err instanceof DOMException && err.name === "AbortError") {
        switch (err.message) {
          case "Another PaymentRequest UI is already showing in a different tab or window.":
            //errr("You can only use this exploit in one tab");
            break;
          case "The payment handler navigated to a page with insecure context, invalid certificate state, or malicious content.":
            errr(
              "Can't access the URL. Either it is erroneous or it is blocked by Google Safe Browsing"
            );
            break;
          case "User closed the Payment Request UI.":
            console.log("Goodbye");
            break;
          default:
            if (
              err.message.startsWith(
                "Error while trying to use the following icon from the Manifest:"
              )
            ) {
              unblockedImageSelectionUI.show();
              if (requiresImageURLBool) {
                errr(
                  "You failed to provide an image URL that is actually unblocked; try again!"
                );
              } else {
                requiresImageURLBool = true;
                localStorage.setItem("requiresImageURL", true);
                unblockedImageSelectionUI.show();
              }
            }
            errr(err.message);
        }
      } else throw err;
    }
  }
  function generateRandOpenSocialURL() {
    // TODO: Put something random instead of "google"-...
    return "https://google-opensocial.googleusercontent.com/gadgets/ifr?url=https://pr-exploit.glitch.me/index.xml#https://www.google.com";
  }
  function setImageURL() {
    const imageURLEl = document.getElementById("imageURL");

    if (imageURLEl.value !== null) {
      localStorage.setItem("unblockedImageURL", imageURLEl.value);
    } else {
      errr("Provide a URL");
    }
  }
</script>
<div class="inputForm">
  <div class="row">
    <div class="input-field col s6">
      <input
        value="https://www.google.com"
        id="unblockURL"
        type="text"
        class="validate"
        spellcheck="false"
      />
      <label class="active" for="unblockURL">The URL to unblock</label>
      <button class="waves-effect waves-light btn" onclick="tryNav()">
        Unblock
      </button>
    </div>
  </div>
</div>
<br />
<script>
  function tryNav() {
    const textbox = document.getElementById("unblockURL");
    if (textbox.value !== null && textbox.value !== "") unblock(textbox.value);
    else if (hashProvided) unblock();
    // TODO: Use detection to make this error more specific
    else errr("Provide a URL in the textbox or in the URL Fragment");
  }
</script>
<br />
<div id="requiresImageURL" style="border-style: outset">
  <p>
    ⚠️ Because your school district's policy blocks data:image/gif urls you must
    provide a URL to an image file that is unblocked for you ⛔ This feature
    isn't finished, either
  </p>
  <input
    type="text"
    id="imageURL"
    placeholder="An unblocked image URL"
    alt="Required for the Payment Request Manifest"
  />
  <button class="waves-effect waves-light btn" onclick="setImageURL()">
    Set
  </button>
</div>
<script>
  if (requiresImageURLBool) unblockedImageSelectionUI.show();
  else unblockedImageSelectionUI.hide();
</script>
<p style="padding-left: 0.4em">
  <b>Note</b>: This will not protect against network blocks only those done by
  filtering extensions
</p>
<details>
  <summary>How to view in fullscreen</summary>
  <p>
    While spamming <i>Ctrl + R</i> click the <i>Unblock Button</i>. If you can
    do it at the right time, it will open up in a window that looks like a
    pop-up. Try this multiple times.
  </p>
  <p>
    <b>Explanation:</b> whenever it shows processing on the popup and you reload
    at the same time it for some reason detaches into a pop-up. I don't have the
    specific details of why this happens, but I will come back with them soon.
  </p>
</details>
<details>
  <summary>Mirrors</summary>
  <p><a href="https://pr-exploit.glitch.me">Return to the original site</a></p>
  <ul>
    <!-- I don't know why they don't have any bullet points -->
    <li>
      <p><a href="#" id="opensocial-link">GUC</a></p>
    </li>
    <li>
      <p>JS Delivr (not finished)</p>
    </li>
    <li>
      <p>Firewalled Replit (not finished)</p>
    </li>
  </ul>
</details>
<details>
  <summary>Recommendations</summary>
  <div class="innerDetails">
    <p>Set your search engine as:</p>
    <textarea readonly id="search-engine-url"></textarea>
    <button
      class="waves-effect waves-light btn"
      onclick="copySearchEngineURL()"
    >
      Copy
    </button>
  </div>
</details>
<script>
  const opensocialLink = document.getElementById("opensocial-link");
  opensocialLink.href = generateRandOpenSocialURL();

  const urlEl = document.getElementById("search-engine-url");
  urlEl.innerHTML = location.origin + location.pathname + "#%s";
  function copySearchEngineURL() {
    urlEl.focus();
    urlEl.select();
    document.execCommand("copy");
  }
</script>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
  integrity="sha512-NiWqa2rceHnN3Z5j6mSAvbwwg3tiwVNxiAQaaSMSXnRRDh5C2mk/+sKQRw8qjV1vN4nf8iK2a0b048PnHbyx+Q=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
