<script>
  let hashProvided = window.location.hash !== "";

  function errr(msg) {
    alert(`Error: ${msg}`);
  }

  const unblockedImageSelectionUI = {
    show: () =>
      (document.getElementById("requiresImageURL").style.visibility =
        "visible"),
    hide: () =>
      (document.getElementById("requiresImageURL").style.visibility = "hidden"),
  };

  var requiresImageURLBool = !!localStorage.getItem("requiresImageURL");

  async function unblock(url = window.location.hash.substring(1)) {
    if (!("PaymentRequest" in window)) {
      errr("the Payment Request API is not supported in your browser");
      return;
    }

    if (url === "") {
      errr("The URL provided is blank");
      return;
    } else
      try {
        const parsedURL = new URL(url);
        if (
          parsedURL.protocol === "http:" &&
          parsedURL.hostname !== "localhost"
        ) {
          err("the URL needs to be of a Secure Context. Try https instead.");
          return;
        }
      } catch (err) {
        errr("invalid URL provided");
        return;
      }

    const request = new PaymentRequest(
      [
        {
          supportedMethods: `https://pr-exploit.glitch.me/pay`,
        },
      ],
      {
        id: url,
        total: {
          label: "total",
          amount: { value: "1", currency: "USD" },
        },
      }
    );
    try {
      const paymentResponse = await request.show();
    } catch (err) {
      if (err instanceof DOMException && err.name === "AbortError") {
        switch (err.message) {
          case "Another PaymentRequest UI is already showing in a different tab or window.":
            //errr("You can only use this exploit in one tab");
            break;
          case "The payment handler navigated to a page with insecure context, invalid certificate state, or malicious content.":
            errr(
              "Can't access the URL. Either it is erroneous or it is blocked by Google Safe Browsing"
            );
            break;
          case "User closed the Payment Request UI.":
            console.log("Goodbye");
            break;
          default:
            if (
              err.message.startsWith(
                "Error while trying to use the following icon from the Manifest:"
              )
            ) {
              unblockedImageSelectionUI.show();
              if (requiresImageURLBool) {
                errr(
                  "You failed to provide an image URL that is actually unblocked; try again!"
                );
              } else {
                requiresImageURLBool = true;
                localStorage.setItem("requiresImageURL", true);
                unblockedImageSelectionUI.show();
              }
            }
            errr(err.message);
        }
      } else throw err;
    }
  }
  function generateRandOpenSocialURL() {
    // TODO: Put something random instead of "google"-...
    return "https://google-opensocial.googleusercontent.com/gadgets/ifr?url=https://pr-exploit.glitch.me/index.xml#https://www.google.com";
  }
  function setImageURL() {
    const imageURLEl = document.getElementById("imageURL");

    if (imageURLEl.value !== null) {
      localStorage.setItem("unblockedImageURL", imageURLEl.value);
    } else {
      errr("Provide a URL");
    }
  }
</script>
<input type="text" id="unblockURL" placeholder="The URL to unblock" />
<button onclick="tryNav()">Unblock</button><br />
<script>
  function tryNav() {
    const textbox = document.getElementById("unblockURL");
    if (textbox.value !== null && textbox.value !== "") unblock(textbox.value);
    else if (hashProvided) unblock();
    // TODO: Use detection to make this error more specific
    else errr("Provide a URL in the textbox or in the URL");
  }
</script>
<br />
<div id="requiresImageURL" style="border-style: outset">
  <p>
    ⚠️ Because your school district's policy blocks data:image/gif urls you must
    provide a URL to an image file that is unblocked for you ⛔ This feature
    isn't finished, either
  </p>
  <input
    type="text"
    id="imageURL"
    placeholder="An unblocked image URL"
    alt="Required for the Payment Request Manifest"
  />
  <button onclick="setImageURL()">Set</button>
</div>
<script>
  if (requiresImageURLBool) unblockedImageSelectionUI.show();
  else unblockedImageSelectionUI.hide();
</script>
<p>
  Note: This will not protect against network blocks only those done by
  filtering extensions
</p>
<details>
  <summary>How to view in fullscreen</summary>
  Click Unblock and press crtl Explanation: whenever it shows processing on the
  popup and you reload at the same time it for some reason detaches into a
  pop-up. I don't have the specific details of why this happens, but I will come
  back with them soon.
</details>
<details>
  <summary>Mirrors</summary>
  <a href="https://pr-exploit.glitch.me">Return to the original site</a>
  <ul>
    <li>
      <a href="#" id="opensocial-link">GUC</a>
    </li>
    <li>
      <p>JS Delivr (not finished)</p>
    </li>
    <li>
      <p>Firewalled Replit (not finished)</p>
    </li>
  </ul>
</details>
<details>
  <summary>Recommendations</summary>
  <p>Set your search engine as:</p>
  <textarea readonly id="search-engine-url"></textarea>
  <button onclick="copySearchEngineURL()">Copy</button>
</details>
<script>
  const opensocialLink = document.getElementById("opensocial-link");
  opensocialLink.href = generateRandOpenSocialURL();

  const urlEl = document.getElementById("search-engine-url");
  urlEl.innerHTML = location.origin + location.pathname + "#%s";
  function copySearchEngineURL() {
    urlEl.focus();
    urlEl.select();
    document.execCommand("copy");
  }
</script>
